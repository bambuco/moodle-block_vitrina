{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to initialise the block.\n *\n * @module block_vitrina/main\n * @copyright 2023 David Herney @ BambuCo\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {get_strings as getStrings} from 'core/str';\nimport Notification from 'core/notification';\nimport Log from 'core/log';\nimport Ajax from 'core/ajax';\n\n/**\n * Private functions.\n *\n */\n\n// Current instance (optional).\nvar instanceid = [];\n\n// Courses by page.\nvar bypage = [];\n\n// Paging variable controls.\nvar paging = [];\n\n// Filters box.\nvar $filtersbox = null;\n\n// Loading courses.\nvar loading = false;\n\n// Load strings.\nvar strings = [\n    {key: 'courselinkcopiedtoclipboard', component: 'block_vitrina'},\n    {key: 'nocoursesview', component: 'block_vitrina'},\n    {key: 'nomorecourses', component: 'block_vitrina'},\n];\nvar s = [];\n\n/**\n * Load strings from server.\n */\nfunction loadStrings() {\n\n    strings.forEach(one => {\n        s[one.key] = one.key;\n    });\n\n    getStrings(strings).then(function(results) {\n        var pos = 0;\n        strings.forEach(one => {\n            s[one.key] = results[pos];\n            pos++;\n        });\n        return true;\n    }).fail(function(e) {\n        Log.debug('Error loading strings');\n        Log.debug(e);\n    });\n}\n// End of Load strings.\n\n/**\n * Load courses for a tab.\n *\n * @param {integer} uniqueid\n * @param {object} $tabcontent\n */\nfunction loadCourses(uniqueid, $tabcontent) {\n\n    var view = $tabcontent.data('view');\n\n    $tabcontent.addClass('loading');\n    var $coursesbox = $tabcontent.find('.courses-list');\n\n    if (paging[uniqueid] === undefined) {\n        paging[uniqueid] = [];\n    }\n\n    if (paging[uniqueid][view] === undefined) {\n        paging[uniqueid][view] = {\n            loaded: 0,\n            ended: false,\n        };\n    }\n\n    // Not more courses.\n    if (paging[uniqueid][view].ended) {\n        $tabcontent.removeClass('loading');\n        return;\n    }\n\n    // Check active filters.\n    var filters = [];\n\n    if ($filtersbox) {\n        var $fulltextcontrol = $filtersbox.find('.filterfulltext input[name=q]');\n\n        if ($fulltextcontrol.length > 0) {\n            var $fulltext = $fulltextcontrol.val().trim();\n\n            if ($fulltext) {\n                filters.push({\n                    'values': [$fulltext],\n                    'type': 'fulltext',\n                });\n            }\n        }\n\n        $filtersbox.find('.filtercontrol').each(function() {\n            var $control = $(this);\n            var values = [];\n\n            $control.find('.filteroptions input:checked').each(function() {\n                var $option = $(this);\n                values.push($option.val());\n            });\n\n            if (values.length > 0) {\n                filters.push({\n                    'values': values,\n                    'type': $control.data('key')\n                });\n            }\n        });\n    }\n    // End of check active filters.\n\n    loading = true;\n    Ajax.call([{\n        methodname: 'block_vitrina_get_courses',\n        args: {'view': view, 'filters': filters, 'instanceid': instanceid[uniqueid],\n                'amount': bypage[uniqueid], 'initial': paging[uniqueid][view].loaded},\n        done: function(data) {\n\n            if (data && data.length > 0) {\n                paging[uniqueid][view].loaded += data.length;\n\n                if (data.length < bypage[uniqueid]) {\n                    paging[uniqueid][view].ended = true;\n                }\n\n                data.forEach(one => {\n                    $coursesbox.append(one.html);\n                });\n\n            } else {\n                paging[uniqueid][view].ended = true;\n            }\n\n            loading = false;\n            $tabcontent.removeClass('loading');\n\n            if (paging[uniqueid][view].ended) {\n                $tabcontent.addClass('ended');\n                $tabcontent.find('.loadmore').hide();\n\n                var nocoursesbox = $tabcontent.find('.nocourses');\n                var nocoursesmsg = '';\n                if (paging[uniqueid][view].loaded == 0) {\n                    nocoursesmsg = s.nocoursesview;\n                    nocoursesbox.removeClass('hidden');\n                } else {\n                    // Only show the message if not is the first call when reached the end.\n                    if (paging[uniqueid][view].loaded > bypage[uniqueid]) {\n                        nocoursesmsg = s.nomorecourses;\n                        nocoursesbox.removeClass('hidden');\n                    }\n                }\n                nocoursesbox.html(nocoursesmsg);\n            }\n        },\n        fail: function(e) {\n            loading = false;\n            $tabcontent.removeClass('loading');\n            Notification.exception(e);\n            Log.debug(e);\n        }\n    }]);\n\n}\n\n/**\n * Restart all controls to new course load.\n *\n * @param {integer} uniqueid\n */\nfunction restartSearch(uniqueid) {\n    paging[uniqueid] = [];\n    $('#' + uniqueid + ' .block_vitrina-tabs [data-ref]').each(function() {\n        var $tab = $(this);\n        var $tabcontent = $($tab.attr('data-ref'));\n        $tabcontent.removeClass('ended');\n        $tabcontent.find('.loadmore').show();\n        $tabcontent.find('.nocourses').addClass('hidden');\n        $tabcontent.find('.courses-list').empty();\n    });\n}\n\n/**\n * Component initialization.\n *\n * @method init\n *\n * @param {integer} uniqueid\n */\nexport const init = (uniqueid = null) => {\n\n    loadStrings();\n\n    $('[data-vitrina-toggle]').on('click', function() {\n        var $this = $(this);\n        var cssclass = $this.attr('data-vitrina-toggle');\n        var target = $this.attr('data-target');\n\n        $(target).toggleClass(cssclass);\n    });\n\n    if (uniqueid) {\n        $('#' + uniqueid + '.block_vitrina-content').each(function() {\n            var $blockcontent = $(this);\n\n            // Manage tabs.\n            $blockcontent.find('.block_vitrina-tabs').each(function() {\n                var $tabs = $(this);\n                var tabslist = [];\n\n                $tabs.find('[data-ref]').each(function() {\n                    var $tab = $(this);\n                    var $tabcontent = $($tab.data('ref'));\n                    tabslist.push($tab);\n\n                    $tab.on('click', function() {\n                        tabslist.forEach(one => {\n                            $(one.data('ref')).removeClass('active');\n                        });\n\n                        $tabs.find('.active[data-ref]').removeClass('active');\n                        $tab.addClass('active');\n\n                        if ($tabcontent) {\n                            $tabcontent.addClass('active');\n\n                            // Load courses only the first time.\n                            var view = $tabcontent.data('view');\n\n                            if (paging[uniqueid][view] === undefined) {\n                                loadCourses(uniqueid, $tabcontent);\n                            }\n                        }\n                    });\n\n                    $tabcontent.find('.loadmore').on('click', function() {\n                        var $this = $(this);\n\n                        // If is a link, do nothing. Only for buttons.\n                        if ($this.attr('href')) {\n                            return;\n                        }\n\n                        loadCourses(uniqueid, $tabcontent);\n                    });\n                });\n\n                // Load dynamic buttons.\n                $blockcontent.find('[data-vitrina-tab]').each(function() {\n                    var $button = $(this);\n\n                    $button.on('click', function() {\n                        var key = '.tab-' + $button.data('vitrina-tab');\n\n                        tabslist.forEach($tab => {\n                            if ($tab.data('ref').indexOf(key) >= 0) {\n                                $tab.trigger('click');\n                            }\n                        });\n                    });\n                });\n            });\n        });\n    }\n};\n\n/**\n * Initialize functions for the detail page.\n *\n */\nexport const detail = () => {\n    strings.push({key: 'courselinkcopiedtoclipboard', component: 'block_vitrina'});\n\n    $('input[name=\"courselink\"]').on('click', function() {\n        var $input = $(this);\n        $input.select();\n        document.execCommand(\"copy\");\n\n        var $msg = $('<div class=\"msg-courselink-copy\">' + s.courselinkcopiedtoclipboard + '</div>');\n\n        $input.parent().append($msg);\n        window.setTimeout(function() {\n            $msg.remove();\n        }, 1600);\n    });\n\n    init();\n};\n\n/**\n * Initialize functions for the catalog page.\n *\n * @param {string} uniqueid\n * @param {string} view\n * @param {integer} currentinstanceid\n * @param {integer} currentbypage\n */\nexport const catalog = (uniqueid, view, currentinstanceid = 0, currentbypage = 20) => {\n\n    instanceid[uniqueid] = currentinstanceid;\n    bypage[uniqueid] = parseInt(currentbypage);\n    var $tabcontent = $('#' + uniqueid + ' .tabs-content .tab-' + view);\n\n    loadCourses(uniqueid, $tabcontent);\n\n    init(uniqueid);\n};\n\n/**\n * Initialize the filter controls.\n *\n * @param {integer} uniqueid\n * @param {array} selectedfilters\n */\nexport const filters = (uniqueid, selectedfilters = []) => {\n\n    $filtersbox = $('#' + uniqueid);\n\n    var applyFilters = function() {\n\n        if (!loading) {\n            restartSearch(uniqueid);\n            loadCourses(uniqueid, $filtersbox.find('.block_vitrina-tabcontent.active'));\n        }\n    };\n\n    selectedfilters.forEach(filter => {\n\n        if (filter.key === 'fulltext') {\n            $filtersbox.find('.filterfulltext input[name=\"q\"]').val(filter.values.join(' '));\n            return;\n        }\n\n        $filtersbox.find('.filtercontrol[data-key=\"' + filter.key + '\"] .filteroptions').each(function() {\n            var $filteroptions = $(this);\n\n            filter.values.forEach(value => {\n                $filteroptions.find('input[value=\"' + value + '\"]').prop('checked', true);\n            });\n        });\n    });\n\n    $filtersbox.find('.filtercontrol .filteroptions input').on('change', applyFilters);\n\n    $filtersbox.find('.filterfulltext button').on('click', applyFilters);\n    $filtersbox.find('.filterfulltext input').on('keypress', function(e) {\n        if (e.which == 13) {\n            applyFilters();\n        }\n    });\n\n    $filtersbox.find('.vitrina-filter-responsivebutton').on('click', function() {\n        $filtersbox.addClass('opened-popup');\n    });\n\n    $filtersbox.find('.vitrina-filter-closebutton').on('click', function() {\n        $filtersbox.removeClass('opened-popup');\n    });\n\n};\n"],"names":["instanceid","bypage","paging","$filtersbox","loading","strings","key","component","s","loadStrings","forEach","one","then","results","pos","fail","e","debug","loadCourses","uniqueid","$tabcontent","view","data","addClass","$coursesbox","find","undefined","loaded","ended","removeClass","filters","$fulltextcontrol","length","$fulltext","val","trim","push","each","$control","this","values","$option","call","methodname","args","done","append","html","hide","nocoursesbox","nocoursesmsg","nocoursesview","nomorecourses","exception","restartSearch","$tab","attr","show","empty","init","on","$this","cssclass","target","toggleClass","$blockcontent","$tabs","tabslist","$button","indexOf","trigger","$input","select","document","execCommand","$msg","courselinkcopiedtoclipboard","parent","window","setTimeout","remove","currentinstanceid","currentbypage","parseInt","selectedfilters","applyFilters","filter","$filteroptions","value","prop","join","which"],"mappings":"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"}